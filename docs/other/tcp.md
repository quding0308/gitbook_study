### tcp

TCP是面向连接的、可靠的流协议。

**面向连接**指在交换数据之前，需要首先建立一个连接。
**面像字节流的协议**指两端独立选择自己的读和写大小，并不关注对方一次读或写的数据大小。
**双工服务**数据可向两个方向流动，两个方向相互独立。

#### 如何保证可靠

* 连接管理 （创建连接和关闭连接），创建连接后才会发送数据
* 通过 确认应答ack 确保数据已到达
* 通过 验和checkSum 确保数据没有损坏
* 通过 序列号 确保数据的顺序
* （重发控制）丢包后的重发机制
* 通过窗口控制，实现高速传输，减少延迟

### 1. 连接管理

#### 建立连接 

3次handshake

客户端与服务端通过SYN报文段交换彼此的seq。

#### 结束连接

4次handshake

### 2. 超时与重试机制  （可以主动重试，1 1 1 5 10 类似这种）

发送数据后，一直没有等到ack，等待时间超过了设定时间。
    * 重发超时 的计算。通过往返时间和偏差 计算所得。一般为6s。
    * 重发达到一定次数后，如果仍然没有结果，会关闭连接。

在iOS测试，tcp重试机制：一共试11次，前6次间隔1s，最后间隔 32s，共耗时67s。67s后，超时。前10s有6次重试。
时间间隔：1、1、1、1、1、2、4、8、16、32

重试的关键是 **根据给定连接的RTT设置RTO**

若 RTO 设置太短，可能在ACK回来之前，开始重传

若 RTO 设置太长，则可能会延迟重传，降低网路的利用率

根据每次ACK的时间，可以确定 RTT。RTT 是会动态变化的。

##### 平滑的RTT估计值
使用n个样本，通过求平均值来计算。每当有新的值，RTT的估计值就会有更新。

### 3. 数据流与窗口管理

TCP的流量控制 用于调节 发送速率。基于ACK数据包中通告**窗口大小**字段来实现。这种方式提供了明确的接收方返回的信息，避免接收方缓存溢出。


### 4. 拥塞控制（为了 减少失败率，提升发送速度）

当认为网络即将进入拥塞状态时，减缓TCP的传输。难点是：如何判断拥塞？如何减缓TCP传输？何时恢复速度？

#### 如何判断拥塞？

丢包率 被用来判断是否发生拥塞

#### 减缓


### 5. 保活机制（心跳包  keepalive时间 ）

NAT超时 和 网络状态变化 都有可能导致 TCP连接断开。

大部分NAT路由器包含超时机制。大部分移动无线网络运营商都在链路一段时间没有数据通讯时，会淘汰 NAT 表中的对应项，造成链路中断。国内的超时时间是 5分钟。

mars中，每隔4.5 min会发送一次智能心跳。时间 会随着网络的好坏、数据发送频率调整。
会记录心跳失败的次数，当次数增加时会增缩短心跳时间。

其他时间会做一次心跳：
- 切到前台
- 网络变化

更多：https://mp.weixin.qq.com/s/ghnmC8709DvnhieQhkLJpA?

### 术语

**SYN** 在建立连接时，用于同步序列号
**FIN** 该保温袋的发送方已经结束向对方发送数据
**ACK** 确认
**RST** 重置连接

**ISN(c)** 客户端初始序列号
**ISN(s)** 服务器端初始序列号

**RTT** 
**RTO** 重试时间

### mars

#### 弱网优化

弱网情况下 上下行 3k/2k mars 明显优于 websocket，websocket 基本收不到消息
弱网情况下 上下行 8k 断网重连后，明显优于websocket 快 3s 左右 

#### 连接优化
iOS 的 connect 超时重传如下图所示。超时间隔依次为（1，1，1，1，1，2，4，8，16，32），总共是67s。

这就意味着，在不能立刻确认失败（例如 unreachable 等）的情况下，需要67秒的时间，才能获得结果。如果真相并不是用户的网络不可用，而是某台服务器故障、繁忙、网络不稳定等因素，那75秒的时间只能尝试1个 IP&Port 资源，对于大多数移动应用而言，是不可接受的。我们需要更积极的超时重传机制！！！

我们不能修改TCP的超时机制。在应用层超时重传，典型做法就是提前结束 connect 的阻塞调用，使用新的 IP&Port 资源进行 connect 重试。

更多详细：https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&mid=2649286458&idx=1&sn=320f690faa4f97f7a49a291d4de174a9&chksm=8334c3b8b4434aae904b6d590027b100283ef175938610805dd33ca53f004bd3c56040b11fa6#rd

#### 发消息优化

长短连 两种模式自动切换

发的数据多的时候，长连可能会慢，会切换到 短连发送
弱网情况下，长连可能已经断了，此时 通过短连发送效果会更好

#### 智能心跳优化 

根据 前后台状态 和 心跳失败的次数 自动判断 心跳的时间

#### 多IP

自动切换IP，提升连接速度

#### 超时重传

在TCP的超时重传的基础上，在应用层有自己的超时重传逻辑，尽可能提高成功率。

TCP 层的超时重传机制可以发现，当发生超时重传时，重传的间隔以“指数退避”的规律急剧上升。在 Android 系统中，直到16分钟，TCP 才确认失败；在 iOS 系统中，直到1分半到3分半之间，TCP 才确认失败。这些数值在大部分应用中都是不为“用户体验”所接受的。用户体验太差。

设计思路：
- 减少等待时间，增加重试次数
- 切换链路(ip/port)，重新建立连接

优化1：

根据网络的状况：优质、正常、差，分别设置超时时间。优质的网络，超时时间设置短（预期网络恢复快）

#### xlog 高效的日志系统

##### 收集日志 不卡顿，会压缩

##### 自动上传，指定某个用户的日志上传

更多：https://mp.weixin.qq.com/s/PnICVDyVuMSyvpvTrdEpSQ?

### 参考
- mars：
- （流是不间断的数据结构，类似管道中的水流）
- https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&mid=2649286458&idx=1&sn=320f690faa4f97f7a49a291d4de174a9&chksm=8334c3b8b4434aae904b6d590027b100283ef175938610805dd33ca53f004bd3c56040b11fa6#rd
- 